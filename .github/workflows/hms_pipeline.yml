name: HMS Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/hms

jobs:
  test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v3
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          echo "Workspace path: $GITHUB_WORKSPACE"
          ls -al $GITHUB_WORKSPACE
          pip install -r $GITHUB_WORKSPACE/Requirements.txt
          pip install flake8 pytest
      
      - name: Add project root to PYTHONPATH
        run: |
          echo "PYTHONPATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Test with pytest
        run: |
          pytest -q

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.IMAGE_NAME }}:latest
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

      - name: print image info
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        run: |
          echo "Built and pushed images:"
          echo "${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "${{ env.IMAGE_NAME }}:latest"

  deploy:
    name: Deploy to AWS ECS
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    env:
      ECS_CLUSTER: PipelineP-HMS
      ECS_SERVICE: HMS-service-4ayod0w4
      ECS_REGION: eu-west-1
      AWS_ACCOUNT_ID: 596797808861

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.ECS_REGION }}

      - name: Get current ECS task definition
        id: task_def
        run: |
          TASK_DEF_ARN=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.ECS_REGION }} \
            --query 'services[0].taskDefinition' \
            --output text)
          echo "task_def_arn=${TASK_DEF_ARN}" >> $GITHUB_OUTPUT
          
          # Extract task definition name (without revision)
          TASK_DEF_NAME=$(echo ${TASK_DEF_ARN} | cut -d: -f6 | cut -d/ -f2)
          echo "task_def_name=${TASK_DEF_NAME}" >> $GITHUB_OUTPUT
          
          # Store current revision for rollback
          CURRENT_REVISION=$(echo ${TASK_DEF_ARN} | cut -d: -f7)
          echo "current_revision=${CURRENT_REVISION}" >> $GITHUB_OUTPUT

      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ steps.task_def.outputs.task_def_arn }} \
            --region ${{ env.ECS_REGION }} \
            --query 'taskDefinition' \
            --output json > task_definition.json

      - name: Update task definition with new image
        id: new_task_def
        run: |
          # Replace image reference in task definition
          NEW_TASK_DEF=$(cat task_definition.json | \
            jq --arg IMAGE "${{ env.IMAGE_NAME }}:${{ github.sha }}" \
            '.containerDefinitions[0].image = $IMAGE | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)')
          
          echo "${NEW_TASK_DEF}" > new_task_definition.json
          cat new_task_definition.json

      - name: Register new task definition
        id: register_task
        run: |
          REGISTERED_DEF=$(aws ecs register-task-definition \
            --region ${{ env.ECS_REGION }} \
            --cli-input-json file://new_task_definition.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "new_task_def_arn=${REGISTERED_DEF}" >> $GITHUB_OUTPUT
          echo "Registered new task definition: ${REGISTERED_DEF}"

      - name: Update ECS service with new task definition
        id: update_service
        continue-on-error: true
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.register_task.outputs.new_task_def_arn }} \
            --region ${{ env.ECS_REGION }} \
            --output json

      - name: Wait for service to stabilize
        id: wait_service
        continue-on-error: true
        run: |
          echo "Waiting for ECS service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.ECS_REGION }} \
            --max-attempts 120
          
          if [ $? -eq 0 ]; then
            echo "Service stabilized successfully"
          else
            echo "Service deployment failed"
            exit 1
          fi

      - name: Verify new tasks are running
        id: verify_tasks
        continue-on-error: true
        run: |
          RUNNING_COUNT=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.ECS_REGION }} \
            --query 'services[0].runningCount' \
            --output text)
          
          DESIRED_COUNT=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.ECS_REGION }} \
            --query 'services[0].desiredCount' \
            --output text)
          
          echo "Running tasks: ${RUNNING_COUNT}/${DESIRED_COUNT}"
          
          if [ "${RUNNING_COUNT}" -eq "${DESIRED_COUNT}" ]; then
            echo "All desired tasks are running"
          else
            echo "Not all tasks are running. Running: ${RUNNING_COUNT}, Desired: ${DESIRED_COUNT}"
            exit 1
          fi

      - name: Configure Datadog APM for monitoring
        run: |
          echo "Configuring Datadog APM and monitoring..."
          echo "Datadog API Key: ${{ secrets.DATADOG_API_KEY }}"
          
          # Create a marker event in Datadog for deployment
          curl -X POST "https://api.datadoghq.eu/api/v1/events" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: ${{ secrets.DATADOG_API_KEY }}" \
            -d "{
              \"title\": \"HMS Deployment Started\",
              \"text\": \"Deploying HMS to ECS - Commit: ${{ github.sha }}\n\nCluster: ${{ env.ECS_CLUSTER }}\nService: ${{ env.ECS_SERVICE }}\nImage: ${{ env.IMAGE_NAME }}:${{ github.sha }}\",
              \"tags\": [
                \"service:hms\",
                \"env:production\",
                \"version:${{ github.sha }}\",
                \"cluster:${{ env.ECS_CLUSTER }}\"
              ],
              \"alert_type\": \"info\"
            }" \
            || echo "⚠️ Datadog event creation skipped (API key may not be configured)"

      - name: Deployment successful
        if: success()
        run: |
          echo "Deployment completed successfully"
          echo "Image: ${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "Cluster: ${{ env.ECS_CLUSTER }}"
          echo "Service: ${{ env.ECS_SERVICE }}"
          echo "Region: ${{ env.ECS_REGION }}"
          
          # Send success event to Datadog
          curl -X POST "https://api.datadoghq.eu/api/v1/events" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: ${{ secrets.DATADOG_API_KEY }}" \
            -d "{
              \"title\": \"HMS Deployment Successful\",
              \"text\": \"HMS successfully deployed to ECS\n\nCluster: ${{ env.ECS_CLUSTER }}\nService: ${{ env.ECS_SERVICE }}\nImage: ${{ env.IMAGE_NAME }}:${{ github.sha }}\",
              \"tags\": [
                \"service:hms\",
                \"env:production\",
                \"version:${{ github.sha }}\",
                \"cluster:${{ env.ECS_CLUSTER }}\"
              ],
              \"alert_type\": \"success\"
            }" \
            || echo "Datadog event creation skipped"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed! Rolling back to previous task definition..."
          echo "Previous task definition: ${{ steps.task_def.outputs.task_def_arn }}"
          
          # Send failure event to Datadog
          curl -X POST "https://api.datadoghq.eu/api/v1/events" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: ${{ secrets.DATADOG_API_KEY }}" \
            -d "{
              \"title\": \"HMS Deployment Failed - Rollback Initiated\",
              \"text\": \"HMS deployment failed. Initiating automatic rollback.\n\nCluster: ${{ env.ECS_CLUSTER }}\nService: ${{ env.ECS_SERVICE }}\nRolling back to: ${{ steps.task_def.outputs.task_def_arn }}\",
              \"tags\": [
                \"service:hms\",
                \"env:production\",
                \"version:${{ github.sha }}\",
                \"cluster:${{ env.ECS_CLUSTER }}\"
              ],
              \"alert_type\": \"error\"
            }" \
            || echo "Datadog event creation skipped"
          
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.task_def.outputs.task_def_arn }} \
            --region ${{ env.ECS_REGION }}
          
          echo "Waiting for service to stabilize after rollback..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region ${{ env.ECS_REGION }} \
            --max-attempts 120
          
          echo "Rollback completed. Service restored to previous version."
          exit 1

  notify:
    name: Send Notifications
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "Deployment completed successfully"
          else
            echo "Deployment failed"
          fi
